@page
@model HelloWorldWeb.Pages.LeaderboardModel
@{
    ViewData["Title"] = "×˜×‘×œ×ª ××•×‘×™×œ×™×";
}

<link rel="stylesheet" href="/css/site.css" />

<!-- ×¨×§×¢ HTML ×‘×œ×‘×“ (×œ×œ× GIF) -->
<iframe src="/logo/fsociety_matrix_blue.html" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; border: none; pointer-events: none; opacity: 0.1;"></iframe>

<!-- ×œ×•×’×• -->
<div class="logo-header">
    <img src="/logo/logo.png" alt="WINTERNET QUIZ" style="max-width: 400px; height: auto;" />
</div>

<!-- ×›×¤×ª×•×¨ ×—×–×¨×” ×œ×—×™×“×•×Ÿ â€“ ×©×××œ ×œ××¢×œ×” -->
<a href="/Index" class="next-question-btn" style="position: fixed; top: 20px; left: 20px; text-decoration: none;">â¬… ×—×–×¨×” ×œ×—×™×“×•×Ÿ</a>

<!-- ×˜×‘×œ×ª ××•×‘×™×œ×™× -->
<div class="quiz-container" style="text-align:center;">
    <h2 style="margin-bottom: 5px;">ğŸ† ×˜×‘×œ×ª ×”××•×‘×™×œ×™×</h2>
    <div id="last-update" style="font-size: 12px; color: #888; margin-bottom: 20px;">(××ª×¢×“×›×Ÿ...)</div>

    <table id="leaderboard-table" style="width: 100%; border-collapse: collapse; margin-top: 10px; color: white; direction: ltr; text-align: left; margin-left: 0; margin-right: auto;">
        <thead>
            <tr style="background-color: #333;">
                <th style="padding: 12px; text-align: left; direction: ltr;">#</th>
                <th style="padding: 12px; text-align: left; direction: ltr;">×©× ××©×ª××©</th>
                <th style="padding: 12px; text-align: left; direction: ltr;">×ª×©×•×‘×•×ª × ×›×•× ×•×ª</th>
            </tr>
        </thead>
        <tbody>
        @for (int i = 0; i < Model.SortedUsers.Count; i++)
        {
            var user = Model.SortedUsers[i];
            var isOnline = user.LastSeen != null && user.LastSeen > DateTime.UtcNow.AddMinutes(-5);
            <tr style="background-color:@(i % 2 == 0 ? "#222" : "#111");">
                <td style="padding: 10px; text-align: left; direction: ltr;">@(@i + 1)</td>
                <td style="padding: 10px; text-align: left; direction: ltr;">
                    @if (isOnline)
                    {
                        <strong style="color: var(--rojo);">@user.Username</strong>
                    }
                    else
                    {
                        @user.Username
                    }
                </td>
                <td style="padding: 10px; text-align: left; direction: ltr;">@user.CorrectAnswers</td>
            </tr>
        }
        </tbody>
    </table>
</div>

<script>
let updateInterval;
let clockInterval;

async function fetchLeaderboardData() {
    try {
        const response = await fetch('/api/leaderboard-data?_=' + new Date().getTime());
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data && data.users && Array.isArray(data.users)) {
            updateLeaderboardTable(data.users, data.currentUsername);
            window.__lastUpdateAt = Date.now();
        } else {
            console.warn('Invalid data received from server');
        }
        
    } catch (error) {
        console.warn('Failed to fetch leaderboard data:', error);
        document.getElementById('last-update').textContent = '(×©×’×™××” ×‘×¢×“×›×•×Ÿ - ××—×›×”...)';
    }
}

function updateLeaderboardTable(data, currentUsername) {
    const table = document.getElementById('leaderboard-table');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    
    data.forEach((user, index) => {
        const row = tbody.insertRow();
        row.style.backgroundColor = index % 2 === 0 ? '#222' : '#111';
        
        const rankCell = row.insertCell();
        rankCell.style.padding = '10px';
        rankCell.style.textAlign = 'left';
        rankCell.style.direction = 'ltr';
        rankCell.textContent = user.rank;
        
        const usernameCell = row.insertCell();
        usernameCell.style.padding = '10px';
        usernameCell.style.textAlign = 'left';
        usernameCell.style.direction = 'ltr';
        
        if (user.isOnline) {
            const strongElement = document.createElement('strong');
            strongElement.style.color = 'var(--rojo)';
            strongElement.textContent = user.username;
            usernameCell.appendChild(strongElement);
        } else {
            usernameCell.textContent = user.username;
        }
        
        const correctCell = row.insertCell();
        correctCell.style.padding = '10px';
        correctCell.style.textAlign = 'left';
        correctCell.style.direction = 'ltr';
        correctCell.textContent = user.correctAnswers;
    });
}

function startAutoUpdate() {
    updateInterval = setInterval(fetchLeaderboardData, 5000);
    if (!clockInterval) {
        clockInterval = setInterval(() => {
            const el = document.getElementById('last-update');
            if (!el) return;
            const t = window.__lastUpdateAt || Date.now();
            const now = new Date();
            el.textContent = `(×¢×•×“×›×Ÿ ×‘-${now.toLocaleTimeString('he-IL')})`;
        }, 200);
    }
}

function stopAutoUpdate() {
    if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
    }
    if (clockInterval) {
        clearInterval(clockInterval);
        clockInterval = null;
    }
}

window.addEventListener('load', () => {
    fetchLeaderboardData();
    startAutoUpdate();
});

document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        stopAutoUpdate();
    } else {
        startAutoUpdate();
    }
});
</script><!-- Footer -->
<footer class="site-footer">
    <p>
        ×¤×•×ª×— ×¢×´×™ <a href="https://www.linkedin.com/in/yaniv-bahalul/" target="_blank" rel="noopener noreferrer">
            ×™× ×™×‘ ×‘×”×œ×•×œ
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
                <rect width="4" height="12" x="2" y="9"></rect>
                <circle cx="4" cy="4" r="2"></circle>
            </svg>
        </a> â€¢ ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª Â©
    </p>
</footer>

